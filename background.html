<html>

<script type="text/javascript" src="/js/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="/js/pref.js"></script>
<script type="text/javascript" src="/js/carrier.js"></script>
<script type="text/javascript" src="/js/util.js"></script>
<script type="text/javascript" src="/js/core.js"></script>
<script type="text/javascript" src="/js/webRequestHandler.js"></script>
<script type="text/javascript" src="/js/db.js"></script>

<script>

    function onInstall() {
      log("Extension Installed");
    }

    function onUpdate() {
      log("Extension Updated");
    }

    function getVersion() {
      var details = chrome.app.getDetails();
      return details.version;
    }

    $(document).ready(function () {
        console.log("ready");
        checkDb();
        chrome.webRequest.onBeforeSendHeaders.addListener(
                onBeforeSendHeaders,
                opt_filter,
                blockingInfoSpec);

        // Check if the version has changed.
        var currVersion = getVersion();
        var prevVersion = localStorage['version']
        if (currVersion != prevVersion) {
          // Check if we just installed this extension.
          if (typeof prevVersion == 'undefined') {
            onInstall();
          } else {
            onUpdate();
          }
          localStorage['version'] = currVersion;
        }
    });

    var dolog = false;

    function log(message) {
        if (dolog) {
            console.log("log:" + message);
        }
    }

    function addUserAgent(useragent, onsuccess) {
        if (dolog) {
            console.log("adding ua");
        }
        indexedDB.addUserAgent(useragent, onsuccess);
    }

    function updateUserAgent(key, useragent, onsuccess) {
        if (dolog) {
            console.log("updating ua, key:" + key);
        }
        indexedDB.updateUserAgent(key, useragent, onsuccess);
    }

    function deleteUserAgent(key, onsuccess) {
        if (dolog) {
            console.log("deleting ua");
        }
        indexedDB.deleteUserAgent(key, onsuccess);
    }

    function loadUserAgent(key, callback) {
        if (dolog) {
            console.log("loading ua");
        }
        indexedDB.loadUserAgent(key, callback);
    }

    var uaList;

    function renderUaLine(row) {
        uaList.push(row.value);
    }

    function loadUserAgents(callback, onsuccess) {
        uaList = new Array();
        if (dolog) {
            console.log("loading all uas");
        }
        if (!callback) {
            indexedDB.getAllUserAgents(renderUaLine, function () {
                chrome.extension.sendRequest(uaList);
            });
        }
        else {
            indexedDB.getAllUserAgents(callback, function () {
                onsuccess();
            });
        }
    }

    function importUserAgents(useragents) {
        if (dolog) {
            console.log("importing:" + useragents);
        }
        indexedDB.importUserAgents(useragents);
    }

    function getUa() {
        return currentUa;
    }

    var currentUa;
    var originalUa = navigator.userAgent;
    var uaPerTab = new Array();
    var opt_filter = {
        urls:["*://*/*"]
    };
    var blockingInfoSpec = ["requestHeaders", "blocking"];
    var activeTabId;
    var lastCreatedTabId;

    const HEADER_UA = "User-Agent";

    function updateUa(details) {
        var tabId = details.tabId;
        if (dolog) {
            console.log("updateUa for tabId:" + tabId);
        }
        if(tabId < 0){
            return {requestHeaders:details.requestHeaders};
        }
        var headerDone = false;
        for (var i = 0; i < details.requestHeaders.length; i++) {
            if (headerDone) {
                break;
            }
            var hname = details.requestHeaders[i].name;
            if (hname == HEADER_UA) {
                var uatoset = currentUa;
                if(tabId == lastCreatedTabId && uaPerTab[tabId] == originalUa){
                    uatoset = originalUa;
                }
                if (dolog) {
                    console.log("updateUa: for tabId:" + tabId + ",setting ua to:" + uatoset);
                }
                details.requestHeaders[i].value = uatoset;
                headerDone = true;
            }
        }
        return {requestHeaders:details.requestHeaders};
    }

    function changeUserAgent(userAgent) {
        if (dolog) {
            console.log("originalUa:" + originalUa);
            console.log("updating user-agent to:" + userAgent + " for tab:" + activeTabId);
        }
        uaPerTab[activeTabId] = userAgent;
        if (dolog) {
            console.log("updated:" + uaPerTab[activeTabId]);
        }
        if (userAgent == originalUa) {
            chrome.browserAction.setTitle({title:''});
            chrome.browserAction.setIcon({path:'ua-disabled.png'});
            // todo remove other listeners
            chrome.webRequest.onBeforeSendHeaders.removeListener(updateUa);
        }
        else {
            chrome.browserAction.setTitle({title:userAgent});
            chrome.browserAction.setIcon({path:'ua.png'});
        }
        currentUa = userAgent;
    }


    function tabIsActive(tabId, selectInfo) {
        if (dolog) {
            console.log("(tabIsActive) tab is active:tabId" + tabId + " with selectInfo:" + selectInfo);
        }
        activeTabId = tabId;
        var uaOfTab = uaPerTab[tabId];
        if (dolog) {
            console.log("(tabIsActive) ua : " + uaOfTab);
        }
        if (uaOfTab != undefined) {
            chrome.browserAction.setTitle({title:uaOfTab});
            changeUserAgent(uaOfTab);
        } else {
            chrome.browserAction.setTitle({title:''});
            chrome.browserAction.setIcon({path:'ua-disabled.png'});
            changeUserAgent(originalUa);
        }
    }
    chrome.tabs.onActiveChanged.addListener(tabIsActive);

    function tabCreated(tab){
        var tabId = tab.id;
        if(dolog){
            console.log("*** tab created, id:" + tabId);
        }
        uaPerTab[tabId] = originalUa;
        lastCreatedTabId = tabId;
    }
    chrome.tabs.onCreated.addListener(tabCreated);

    /*
    function tabUpdated(tabId, changeInfo, tab){
        var status = changeInfo.status;
        if(dolog){
            console.log("*** tab with id:" + tabId + " updated with status:" + status);
        }
    }
    chrome.tabs.onUpdated.addListener(tabUpdated);
    */

    chrome.extension.onRequest.addListener(function (request, sender, sendResponse) {
        console.log("onRequest");
        server[request.name](request, sender, sendResponse);
    });

var server = {
    deviceInfo: function (request, sender, sendResponse) {
        var carrier;
        var id;
        var width;
        var tabselect_enabled = fms.pref.getPref("msim.config.tabselect.enabled");
        if (tabselect_enabled) {
            // TODO get carrier and id for this tab
        } else {
            carrier = fms.pref.getPref("msim.current.carrier");
            id = fms.pref.getPref("msim.current.id");
            width = fms.pref.getPref("msim.devicelist." + id + ".screen-width")
                        || fms.pref.getPref("msim.config.general.screen-width-default");

            console.log(carrier+":"+id);
            //ホスト制限に指定された端末があれば、その端末を使用する
            if (document.contentType == "text/html") {
                if(id){
                    //ホスト制限に指定された端末を取得する
                    var deviceObj = fms.core.getDeviceByLimitHost(document.location.hostname);
                    if(deviceObj){
                        id = deviceObj.index;
                        carrier = fms.pref.getPref("msim.devicelist." + id + ".carrier");
                    }
                }
            }
        }
        sendResponse({
            carrier: carrier,
            id: id,
            width: width
        });
    }
};

</script>
</html>
